<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
/* prefixed by https://autoprefixer.github.io (PostCSS: v7.0.23, autoprefixer: v9.7.3) */

.game-controls {
            font-size: 24px;
            font-family: Arial, Helvetica, sans-serif;
            white-space: nowrap;
        }

        .start {
            background-color: initial;
        }

        .loser {
            background-color: pink;
        }

        .winner {
            background-color: rgb(29, 201, 29);
        }

        .hidden {
            display: none;
        }

        .visible {
            display: block;
        }

        .controls-container {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: horizontal;
            -webkit-box-direction: normal;
                -ms-flex-direction: row;
                    flex-direction: row;
            -ms-flex-pack: distribute;
                justify-content: space-around;
            width: 100%;
        }

        .svg-container {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            height: 240px;
        }

        .svg {
            width: 100%;
        }

        .main-container {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
                -ms-flex-direction: column;
                    flex-direction: column;
            justify-items: center;
            max-width: 612px;
            padding: 10px 0 0 0;
        }

        .disc-label {
            font-family: Arial, Helvetica, sans-serif;
            fill: white;
            stroke: white;
        }

        @media only screen and (max-width: 600px) {
            .main-container {
                max-width: 100%;
            }
        }
        
</style>
</head>

<body>
    <div class="main-container">
        <div class="controls-container">
            <div>
                <label class="game-controls">Rings: </label class="game-controls">
                <input id="txtRings" class="game-controls" type="number" min="3" max="9" value="9" />
            </div>
            <div>
                <button class="game-controls"
                    onclick="onNewGame(document.all.txtRings.value, document.all.txtSpeed.value)">
                    New Game
                </button class="game-controls">
                <button class="game-controls"
                    onclick="automate(document.all.txtRings.value, document.all.txtSpeed.value)">
                    Auto Play
                </button>
            </div>
            <div>
                <label class="game-controls"> Animation Speed: </label>
                <input id="txtSpeed" class="game-controls" onchange="onSpeedChange(this.value)" type="number" min="1"
                    max="10" value="5" />
            </div>
        </div>

        <div class="svg-container">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="svg"
                viewBox="0 0 600 240" preserveAspectRatio="xMidYMid meet">
                <rect id="svgEditorBackground" x="0" y="0" width="600" height="240" fill="none" stroke="black" />
                <rect id="post_0" x="-6" y="-10" fill="brown" width="12" height="200" rx="6" ry="6" transform="translate(100 50)" />
                <rect id="base_0" x="-90" y="-10" fill="brown" width="180" height="10" transform="translate(100 240)" />
                <rect id="post_1" x="-6" y="-10" fill="brown" width="12" height="200" rx="6" ry="6" transform="translate(300 50)" />
                <rect id="base_1" x="-90" y="-10" fill="brown" width="180" height="10" transform="translate(300 240)" />
                <rect id="post_2" x="-6" y="-10" fill="brown" width="12" height="200" rx="6" ry="6" transform="translate(500 50)" />
                <rect id="base_2" x="-90" y="-10" fill="brown" width="180" height="10" transform="translate(500 240)" />
                <g id="g_ring_0" class="visible" transform="translate(100 50)">
                    <rect id="ring_0" x="-24" y="0" fill="red" width="48" height="20" rx="10" ry="10" />
                    <text class="disc-label">
                        <tspan y="15" text-anchor="middle">1</tspan>
                    </text>
                </g>
                <g id="g_ring_1" class="visible" transform="translate(100 70)">
                    <rect id="ring_1" x="-32" y="0" fill="green" width="64" height="20" rx="10" ry="10" />
                    <text class="disc-label">
                        <tspan y="15" text-anchor="middle">2</tspan>
                    </text>
                </g>
                <g id="g_ring_2" class="visible" transform="translate(100 90)">
                    <rect id="ring_2" x="-40" y="0" fill="blue" width="80" height="20" rx="10" ry="10" />
                    <text class="disc-label">
                        <tspan y="15" text-anchor="middle">3</tspan>
                    </text>
                </g>
                <g id="g_ring_3" class="visible" transform="translate(100 110)">
                    <rect id="ring_3" x="-48" y="0" fill="orange" width="96" height="20" rx="10" ry="10" />
                    <text class="disc-label">
                        <tspan y="15" text-anchor="middle">4</tspan>
                    </text>
                </g>
                <g id="g_ring_4" class="visible" transform="translate(100 130)">
                    <rect id="ring_4" x="-56" y="0" fill="red" width="112" height="20" rx="10" ry="10" />
                    <text class="disc-label">
                        <tspan y="15" text-anchor="middle">5</tspan>
                    </text>
                </g>
                <g id="g_ring_5" class="visible" transform="translate(100 150)">
                    <rect id="ring_5" x="-64" y="0" fill="green" width="128" height="20" rx="10" ry="10" />
                    <text class="disc-label">
                        <tspan y="15" text-anchor="middle">6</tspan>
                    </text>
                </g>
                <g id="g_ring_6" class="visible" transform="translate(100 170)">
                    <rect id="ring_6" x="-72" y="0" fill="blue" width="144" height="20" rx="10" ry="10" />
                    <text class="disc-label">
                        <tspan y="15" text-anchor="middle">7</tspan>
                    </text>
                </g>
                <g id="g_ring_7" class="visible" transform="translate(100 190)">
                    <rect id="ring_7" x="-80" y="0" fill="orange" width="160" height="20" rx="10" ry="10" />
                    <text class="disc-label">
                        <tspan y="15" text-anchor="middle">8</tspan>
                    </text>
                </g>
                <g id="g_ring_8" class="visible" transform="translate(100 210)">
                    <rect id="ring_8" x="-88" y="0" fill="purple" width="176" height="20" rx="10" ry="10" />
                    <text class="disc-label">
                        <tspan y="15" text-anchor="middle">9</tspan>
                    </text>
                </g>
                <rect id="hotspot_0" width="180" height="100%" x="-90" y="0" transform="translate(100 0)"
                    fill="transparent" onclick="onHotClick(0)" />
                <rect id="hotspot_1" width="180" height="100%" x="-90" y="0" transform="translate(300 0)"
                    fill="transparent" onclick="onHotClick(1)" />
                <rect id="hotspot_2" width="180" height="100%" x="-90" y="0" transform="translate(450 0)"
                    fill="transparent" onclick="onHotClick(2)" />
            </svg>
        </div>
        <div class="controls-container">
            <div>
                <label class="game-controls">Player Moves: </label>
                <label id="txtMovesPlayer" class="game-controls start">0</label>
            </div>
            <div>
                <label class="game-controls">Minimum Moves: </label>
                <label id="txtMovesMin" class="game-controls">0</label>
            </div>
        </div>
    </div>
</body>

<script>
    function ring(game, value, x, y, fill, width, height, tx, ty, visible) {
        this.game = game;
        this.value = value;
        this.x = x;
        this.y = y;
        this.fill = fill;
        this.width = width;
        this.height = height;
        this.tx = tx;
        this.ty = ty;
        this.visible = visible;
        // this.dest = { x: -1, y: -1 };
        this.animSpeed = 1;
        this.isAnimating = false;
        this.path = {};

        this.element = document.querySelector('#g_ring_' + value);
        if (!!this.element) {
            this.element.setAttribute('class', this.visible ? 'visible' : 'hidden');
        }

        this.wait = function () {
            if (this.isAnimating) { return true; }
        }

        this.move = function (destPath, callback) {
            if (this.isAnimating) { return false; }
            // this.dest = dest;
            // this.animSpeed = speed;
            this.path = destPath;
            this.callback = callback;
            this.animate();
        };

        this.animate = function () {
            const dest = this.path.pop();
            if (!dest) {
                this.isAnimating = false;
                if (this.callback) { this.callback(); }
                return;
            }
            dest.s = Math.max(dest.s, this.game.animSpeed);
            let moved = false;
            if (!!dest.x || 0 === dest.x) {
                if (dest.x > this.tx) {
                    this.isAnimating = true;
                    this.tx = Math.min(this.tx + dest.s, dest.x);
                    moved = true;
                } else if (dest.x < this.tx) {
                    this.isAnimating = true;
                    this.tx = Math.max(this.tx - dest.s, dest.x);
                    moved = true;
                }
            }
            if (!!dest.y || 0 === dest.y) {
                if (dest.y > this.ty) {
                    this.isAnimating = true;
                    this.ty = Math.min(this.ty + dest.s, dest.y);
                    moved = true;
                } else if (!!dest.y && dest.y < this.ty) {
                    this.isAnimating = true;
                    this.ty = Math.max(this.ty - dest.s, dest.y);
                    moved = true;
                }
            }
            if (!!moved) {
                this.path.push(dest);
                this.isAnimating = true;
                this.transform();
            }
            requestAnimationFrame(this.animate.bind(this));
        };

        this.transform = function () {
            this.element.attributes['transform'].value = 'translate(' + this.tx + ',' + this.ty + ')';
        };
        this.transform();

        this.select = function (ty, speed) {
            if (this.isAnimating) { return false; }
            this.move([{ y: ty - this.height - 10, s: 2 * speed }]);
        };
    }
    function post(x, yTop, yBottom) {
        this.x = x;
        this.yTop = yTop;
        this.yBottom = yBottom;
        this.rings = [];
    }

    function game(rings, speed) {
        this.rings = +rings;
        this.inProgress = false;
        this.posts = [];
        this.source = -1;
        this.dest = -1;
        this.selected = null;
        this.animSpeed = +speed || 1;
        this.moveCount = 0;
        this.moveMin = Math.pow(2, this.rings) - 1;
        this.script = [];

        this.init = function () {
            showMoves(this.moveCount, this.moveMin);
            this.inProgress = true;
            for (let i = 0; i < 3; i++) {
                this.posts.push(new post(100 + (i * 200), 40, 230));
            }
            const startPost = new post(this.posts[0].x, this.posts[0].yTop, this.posts[0].yBottom);
            const ringHeight = 20;
            for (let i = 0; i < 9; i++) {
                startPost.rings.push(new ring(this,
                    i, -20 - (i * 6), 0, null, 40 + (i * 12), ringHeight, startPost.x, 50 + (i * ringHeight), (i < rings))
                );
            }
            const post0 = this.posts[0];
            for (let i = 0; i < 9; i++) {
                const ring = startPost.rings.pop();
                if (ring.value < rings) {
                    post0.rings.push(ring);
                    ring.ty = post0.yBottom - (ring.height * post0.rings.length);
                    ring.transform();
                }
            }
        };

        this.autoMove = function(n, source, target, auxiliary, script) {
            if (!script) { script = []; }
            if (0 >= n) { return script; }
            script = this.autoMove(n - 1, source, auxiliary, target, script);
            const ring = source.rings.pop();
            target.rings.push(ring);
            script.push({
                ring: ring, moves: [
                    { y: target.yBottom - (ring.height * target.rings.length), s: this.animSpeed },
                    { x: target.x, s: this.animSpeed },
                    { y: source.yTop - ring.height - 10, s: this.animSpeed }
                ]
            });

            script = this.autoMove(n - 1, auxiliary, target, source, script);
            return script;
        };

        this.runScript = function() {
            const item = this.script.pop();
            if (!item) { return; }
            const self = this;
            item.ring.move(item.moves, function() {
                showMoves(++self.moveCount, self.moveMin);
                self.runScript();
            });
        };

        this.automate = function() {
            this.inProgress = false;
            const bwScript = this.autoMove(this.rings,
                this.posts[0],
                this.posts[2],
                this.posts[1]);

            this.script = bwScript.reverse();

            this.runScript();
        };
    }

    var theGame = null;

    function showMoves(player, min) {
        const g = theGame;
        if (!g) { return; }
        let color = 'start';
        if (0 !== player && player >= min) {
            if (g.inProgress) {
                color = 'loser';
            } else {
                if (player === min) { color = 'winner'; }
                else { color = 'loser'; }
            }
        }
        const elMp = document.querySelector('#txtMovesPlayer');
        if (!!elMp) {
            elMp.innerText = player;
            elMp.classList.remove(elMp.classList.item(elMp.classList.length - 1));
            elMp.classList.add(color);
        }
        const elMm = document.querySelector('#txtMovesMin');
        if (!!elMm) { elMm.innerText = min; }
    }

    function onHotClick(idx) {
        const g = theGame;
        if (!g || !g.inProgress) { return; }
        if (!!g.selected) {
            if (g.selected.isAnimating) { return; }
            g.dest = idx;
            const post = g.posts[idx];
            const temp = post.rings.pop();
            if (!temp || g.selected.value < temp.value) {
                // put back temp and put selected on top
                if (!!temp) { post.rings.push(temp); }
                post.rings.push(g.selected);
                if (g.source !== g.dest) {
                    g.moveCount++;
                }
                g.selected.move(
                    [
                        { y: post.yBottom - (g.selected.height * post.rings.length), s: g.animSpeed },
                        { x: post.x, s: g.animSpeed }
                    ]);
                g.selected = null;
                g.source = g.dest = -1;
                if (idx !== 0 && post.rings.length === g.rings) { g.inProgress = false; }
                showMoves(g.moveCount, g.moveMin);
            } else {
                if (!!temp) {
                    post.rings.push(temp);
                }
                g.dest = -1;
            }
        } else {
            const post = g.posts[idx];
            const ring = post.rings.pop();
            if (!ring) { return; }
            g.source = idx;
            g.selected = ring;
            ring.select(post.yTop, g.animSpeed);
        }
    }

    function automate(rings, speed) {
        theGame = new game(+rings, +speed);
        theGame.init();
        theGame.automate();
    }

    function onSpeedChange(speed) {
        if (!!theGame) {
            theGame.animSpeed = +speed;
        }
    }

    function onNewGame(rings, speed) {
        theGame = new game(+rings, +speed);
        theGame.init();
    }

</script>

</html>